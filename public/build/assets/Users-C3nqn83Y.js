import{r as v,c as q,w as Z,b as B,o,e as $,i as l,z as _,g as s,t as d,k as D,F as j,m as V,v as X,j as O,E as ee,G as se,f as P,n as te,u as H,p as K,N as oe,W as Q,l as g,d as re,L as le,x as Y,s as ae,H as ne,b8 as ie,y as de,h as ue,aX as ce}from"./app-0hD9jktS.js";import{_ as pe}from"./AppLayout.vue_vue_type_script_setup_true_lang-C_OfVMdc.js";import{_ as me}from"./Layout.vue_vue_type_script_setup_true_lang-Bi3HrDun.js";import{a as ge,_ as fe}from"./PasswordVerificationModal-DZybDfO-.js";import{_ as xe}from"./BaseDataTable.vue_vue_type_style_index_0_lang-CTigQWSr.js";import{E as ye}from"./eye-Dtz9j6o0.js";import{E as be}from"./eye-off-B84CHv0x.js";import{u as he}from"./school-SWVnhMs_.js";import"./RovingFocusGroup-BrsbekXI.js";import"./AvatarImage.vue_vue_type_script_setup_true_lang-DLhJV-ve.js";import"./AppLogo.vue_vue_type_script_setup_true_lang-DV00-4L5.js";import"./building-2-0J7JWYjO.js";import"./users-CQiJNf1m.js";import"./chevron-down-Bc9-FnA7.js";import"./check-DytFQTDT.js";const ve={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/40"},ke={class:"relative z-50 bg-white dark:bg-neutral-900 p-6 rounded-lg shadow-lg min-w-[400px] max-w-md mx-auto w-full"},_e={class:"flex items-center gap-3 mb-4 border-b pb-3"},we=["src"],Re={class:"font-semibold text-base"},$e={class:"text-xs text-gray-500"},Ae={class:"mb-4 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg"},Ce={class:"flex items-center justify-between gap-2"},je={class:"text-sm text-purple-800 dark:text-purple-200"},Se={class:"mb-4"},Ve={value:"",disabled:""},Ue=["value"],Me={key:0,class:"text-xs text-orange-600 dark:text-orange-400 mt-1"},Ee={key:1,class:"text-xs text-red-500 mt-1"},Pe={class:"flex justify-end gap-2 mt-4"},Te=["disabled"],Ne={key:0,class:"animate-spin h-4 w-4",fill:"none",viewBox:"0 0 24 24"},Oe={class:"my-4 border-t pt-4"},Be={key:0},Fe={class:"space-y-2"},De={class:"font-medium text-sm"},He={key:0,class:"text-xs px-2.5 py-1 rounded-full font-medium shadow-sm bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 border border-purple-200 dark:border-purple-800 mr-1 mb-1"},Ie={key:1,class:"italic text-xs text-gray-400"},Le={key:1,class:"italic text-xs text-gray-400 p-2 bg-gray-50 dark:bg-neutral-800 rounded"},ze={__name:"RoleAssignModal",props:{modelValue:Boolean,user:{type:Object,default:null},school:{type:Object,default:null},roles:{type:Array,default:()=>[]},assigningRole:Boolean,assignRoleError:String},emits:["update:modelValue","assign","cancel"],setup(c,{emit:R}){const p=c,k=R,x=v(""),f=q(()=>!p.roles||!p.school?[]:p.roles.filter(m=>m.school_id===p.school.id));Z(()=>p.modelValue,m=>{m||(x.value="")});function y(m){return m.map(u=>u.name).join(", ")}function U(){k("assign",x.value)}function F(){k("cancel"),k("update:modelValue",!1)}return(m,u)=>(o(),B(ee,{"model-value":c.modelValue,"onUpdate:modelValue":u[1]||(u[1]=S=>m.$emit("update:modelValue",S))},{default:$(()=>{var S,T;return[c.user?(o(),l("div",ve,[s("div",ke,[u[7]||(u[7]=s("h2",{class:"text-lg font-bold mb-4 text-center"},"Assign Role",-1)),s("div",_e,[c.user.profile_photo_url?(o(),l("img",{key:0,src:c.user.profile_photo_url,alt:"User Avatar",class:"w-10 h-10 rounded-full border object-cover"},null,8,we)):_("",!0),s("div",null,[s("div",Re,d(c.user.name||"N/A"),1),s("div",$e,d(c.user.email||"N/A"),1)])]),s("div",Ae,[s("div",Ce,[u[2]||(u[2]=s("span",{class:"block text-xs font-semibold text-purple-700 dark:text-purple-300"},"Current School Context:",-1)),s("span",je,d(((S=c.school)==null?void 0:S.name)||"No school selected"),1)]),u[3]||(u[3]=s("div",{class:"text-xs text-purple-600 dark:text-purple-400 mt-1"},"Roles will be assigned for this school",-1))]),s("div",Se,[u[4]||(u[4]=s("label",{class:"block text-sm font-medium mb-1"},"Select Role to Assign",-1)),D(s("select",{"onUpdate:modelValue":u[0]||(u[0]=b=>x.value=b),class:"w-full px-3 py-2 rounded border dark:bg-neutral-800 dark:text-white focus:ring-2 focus:ring-purple-400"},[s("option",Ve,"Select a role for "+d(((T=c.school)==null?void 0:T.name)||"selected school"),1),(o(!0),l(j,null,V(f.value,b=>(o(),l("option",{key:b.id,value:b.name},d(b.name),9,Ue))),128))],512),[[X,x.value]]),f.value.length===0?(o(),l("div",Me,"No roles available for the selected school. Please select a different school or create roles for this school.")):_("",!0),c.assignRoleError?(o(),l("div",Ee,d(c.assignRoleError),1)):_("",!0)]),s("div",Pe,[s("button",{onClick:F,type:"button",class:"px-4 py-2 rounded bg-gray-200 dark:bg-neutral-700 text-gray-700 dark:text-white hover:bg-gray-300 dark:hover:bg-neutral-600"},"Cancel"),s("button",{onClick:U,type:"button",disabled:!x.value||f.value.length===0||c.assigningRole,class:"px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"},[c.assigningRole?(o(),l("svg",Ne,u[5]||(u[5]=[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):_("",!0),O(" "+d(c.assigningRole?"Assigning...":"Assign Role"),1)],8,Te)]),s("div",Oe,[u[6]||(u[6]=s("span",{class:"block text-xs font-semibold text-gray-500 mb-2"},"Current School Affiliations",-1)),c.user&&c.user.roles_by_school&&Object.keys(c.user.roles_by_school).length?(o(),l("div",Be,[s("div",Fe,[(o(!0),l(j,null,V(c.user.roles_by_school,(b,C)=>(o(),l("div",{key:C,class:"flex items-center justify-between px-2 pt-1 bg-gray-50 dark:bg-neutral-800 rounded"},[s("span",De,d(C),1),b.length?(o(),l("span",He,d(y(b)),1)):(o(),l("span",Ie,"No roles"))]))),128))])])):(o(),l("div",Le,"No school affiliations yet"))])])])):_("",!0)]}),_:1},8,["model-value"]))}},qe={class:"mb-6 p-4 rounded shadow bg-gray-100 dark:bg-neutral-800"},We={class:"flex flex-col sm:flex-row gap-4"},Ge={class:"flex-1"},Je={class:"w-full sm:w-48"},Xe=["value"],Ke={class:"w-full sm:w-32"},Qe={key:0,class:"flex items-center justify-center"},Ye=["src"],Ze={key:1,class:"w-8 h-8 rounded-full bg-gray-200 dark:bg-neutral-700 flex items-center justify-center text-sm font-medium text-gray-700 dark:text-gray-300"},es={class:"font-medium text-gray-900 dark:text-gray-100"},ss={key:0,class:"inline-flex items-center px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-800 text-xs"},ts=["title"],os={key:2,class:"text-xs text-gray-400"},rs={class:"flex flex-wrap gap-1.5"},ls=["onClick"],as=["onClick"],ns={key:2,class:"text-gray-400 dark:text-gray-500 text-xs italic"},is={class:"text-gray-600 dark:text-gray-400 text-sm"},ds=["onClick"],us={key:1,class:"text-xs text-gray-500 dark:text-gray-400 italic"},cs=["onClick"],ps={key:0,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ms={key:1,class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},gs={key:0,class:"p-4 bg-gray-50 dark:bg-neutral-800 rounded-b-lg border-t border-gray-200 dark:border-neutral-700"},fs={class:"flex items-center mb-4 pb-4 border-b border-gray-200 dark:border-neutral-700"},xs={class:"flex items-center space-x-4"},ys={class:"relative"},bs=["src","alt"],hs={key:1,class:"w-16 h-16 rounded-full bg-gradient-to-br from-purple-400 to-blue-500 flex items-center justify-center text-white text-xl font-bold border-2 border-gray-300 dark:border-neutral-600 shadow-sm"},vs={class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},ks={class:"text-sm text-gray-600 dark:text-gray-400"},_s={key:0,class:"text-xs text-gray-500 dark:text-gray-500"},ws={class:"flex flex-col md:flex-row gap-4"},Rs={class:"flex-1"},$s={class:"space-y-2"},As={class:"text-sm text-gray-600 dark:text-gray-400 ml-2"},Cs={key:0},js={class:"text-sm text-gray-600 dark:text-gray-400 ml-2"},Ss={key:1},Vs={class:"text-sm text-gray-600 dark:text-gray-400 ml-2"},Us={class:"flex-1"},Ms={key:0},Es={class:"font-medium text-sm"},Ps={key:0,class:"ml-2"},Ts={key:1,class:"ml-2 italic text-xs text-gray-400"},Ns={key:1,class:"italic text-xs text-gray-400"},Os={class:"flex-1"},Bs={class:"flex items-center space-x-2"},Fs={class:"text-sm text-gray-400 dark:text-gray-500"},Ds=["onClick"],Hs=["onClick"],Is={__name:"UsersTable",props:{users:{type:Array,required:!0},roles:{type:Array,required:!0},schools:{type:Array,required:!0},auth:{type:Object,required:!0}},emits:["openAssignRoleModal","togglePasswordVisibility","resetPassword"],setup(c,{emit:R}){const p=c,k=R,x=v(!1),f=v(null),y=se({search:"",role:"",per_page:15});let U;const F=()=>{clearTimeout(U),U=setTimeout(()=>{m()},300)},m=async()=>{x.value=!0;try{const a=new URLSearchParams({search:y.search,role:y.role,per_page:y.per_page.toString(),page:"1"});Q.get("/settings/users",Object.fromEntries(a))}catch(a){console.error("Error applying filters:",a),g.error("Failed to apply filters")}finally{x.value=!1}},u=a=>a?a.split(" ").map(t=>t.charAt(0)).join("").toUpperCase().slice(0,2):"",S=a=>new Date(a).toLocaleDateString(),T=a=>{if(!a)return"Global";const t=p.schools.find(e=>e.id===a);return t?t.name:"Unknown School"},b=a=>{var t,e;return((e=(t=p.auth)==null?void 0:t.user)==null?void 0:e.id)===a},C=a=>!a||!a.roles||!Array.isArray(a.roles)?!1:a.roles.some(t=>t.name==="superadmin"),A=a=>{k("openAssignRoleModal",a)},N=a=>{f.value=f.value===a.id?null:a.id},M=v(!1),I=v({userId:null,roleId:null}),L=(a,t)=>{I.value={userId:a,roleId:t},M.value=!0},W=()=>{const{userId:a,roleId:t}=I.value;G(a,t)},G=async(a,t)=>{try{Q.delete("/settings/user-management/remove-role",{data:{user_id:a,role_id:t},preserveScroll:!0,onSuccess:()=>{g.success("Role removed successfully!");const e=p.users.findIndex(i=>i.id===a);if(e!==-1){const i={...p.users[e]};i.roles_by_school&&Object.keys(i.roles_by_school).forEach(r=>{i.roles_by_school[r]=i.roles_by_school[r].filter(n=>n.id!==t)}),i.roles=i.roles.filter(r=>r.id!==t),p.users[e]=i}},onError:e=>{Object.values(e).flat().forEach(i=>g.error(i))}})}catch{g.error("Failed to remove role")}},E=a=>{if(!a)return[];const t=new Set;return a.roles_by_school?Object.keys(a.roles_by_school).forEach(e=>{e&&a.roles_by_school[e].length>0&&t.add(e)}):a.roles&&a.roles.length>0&&a.roles.forEach(e=>{if(e.school_id){const i=p.schools.find(r=>r.id===e.school_id);i&&t.add(i.name)}}),Array.from(t)},J=[{text:"Avatar",value:"avatar",sortable:!1},{text:"Name",value:"name"},{text:"School",value:"school"},{text:"Roles",value:"roles"},{text:"Joined",value:"joined"},{text:"Actions",value:"actions",sortable:!1}],z=q(()=>p.users.filter(a=>!!a&&typeof a=="object").map(a=>{let t="";if(a.roles&&a.roles.length>0){const e=a.roles[0];e.school_id&&(t=T(e.school_id))}return{...a,school_name:t}}));return(a,t)=>(o(),l("div",null,[s("div",qe,[s("div",We,[s("div",Ge,[t[4]||(t[4]=s("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Search Users",-1)),D(s("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>y.search=e),type:"text",placeholder:"Search by name or email...",class:"w-full px-3 py-2 rounded border border-gray-300 dark:border-neutral-600 bg-white dark:bg-neutral-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary",onInput:F},null,544),[[te,y.search]])]),s("div",Je,[t[6]||(t[6]=s("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Filter by Role",-1)),D(s("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>y.role=e),class:"w-full px-3 py-2 rounded border border-gray-300 dark:border-neutral-600 bg-white dark:bg-neutral-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary",onChange:m},[t[5]||(t[5]=s("option",{value:""},"All Roles",-1)),(o(!0),l(j,null,V(c.roles,e=>(o(),l("option",{key:e.id,value:e.name},d(e.name)+" ("+d(e.school_name)+") ",9,Xe))),128))],544),[[X,y.role]])]),s("div",Ke,[t[8]||(t[8]=s("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"},"Per Page",-1)),D(s("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>y.per_page=e),class:"w-full px-3 py-2 rounded border border-gray-300 dark:border-neutral-600 bg-white dark:bg-neutral-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary",onChange:m},t[7]||(t[7]=[s("option",{value:"10"},"10",-1),s("option",{value:"15"},"15",-1),s("option",{value:"25"},"25",-1),s("option",{value:"50"},"50",-1)]),544),[[X,y.per_page]])])])]),P(xe,{headers:J,items:z.value,loading:x.value,expandable:!0,"expand-row-keys":f.value?[f.value]:[]},{"item-avatar":$(e=>[e?(o(),l("div",Qe,[e.profile_photo_url?(o(),l("img",{key:0,src:e.profile_photo_url,class:"w-8 h-8 rounded-full border object-cover"},null,8,Ye)):(o(),l("div",Ze,d(e!=null&&e.name?u(e.name):"?"),1))])):_("",!0)]),"item-name":$(e=>[s("span",es,d(e.name),1)]),"item-school":$(e=>[E(e).length===1?(o(),l("span",ss,d(E(e)[0]),1)):E(e).length>1?(o(),l("span",{key:1,class:"inline-flex items-center px-2 py-1 rounded bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 border border-yellow-200 dark:border-yellow-800 text-xs cursor-pointer",title:E(e).join(", ")}," Multiple ",8,ts)):(o(),l("span",os,"No school"))]),"item-roles":$(e=>[s("div",rs,[e.roles_by_school&&Object.keys(e.roles_by_school).length?(o(!0),l(j,{key:0},V(e.roles_by_school,(i,r)=>(o(),l("div",{key:r},[(o(!0),l(j,null,V(i,n=>(o(),l("span",{key:n.id,class:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium shadow-sm bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 border border-purple-200 dark:border-purple-800 mr-1 mb-1"},[O(d(n.name)+" ",1),!C(e)&&!b(e.id)?(o(),l("button",{key:0,onClick:K(h=>L(e.id,n.id),["stop"]),class:"ml-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300",title:"Remove role"},t[9]||(t[9]=[s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]),8,ls)):_("",!0)]))),128))]))),128)):(o(!0),l(j,{key:1},V(e.roles,i=>(o(),l("span",{key:i.id+"-"+(i.school_id||"global"),class:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium shadow-sm bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 border border-purple-200 dark:border-purple-800"},[O(d(i.name)+" ",1),!C(e)&&!b(e.id)?(o(),l("button",{key:0,onClick:K(r=>L(e.id,i.id),["stop"]),class:"ml-1 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300",title:"Remove role"},t[10]||(t[10]=[s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]),8,as)):_("",!0)]))),128)),(!e.roles||e.roles.length===0)&&(!e.roles_by_school||Object.keys(e.roles_by_school).length===0)?(o(),l("span",ns,"No roles assigned")):_("",!0)])]),"item-joined":$(e=>[s("span",is,d(S(e.created_at)),1)]),"item-actions":$(e=>[C(e)?(o(),l("span",us,"Super Admin")):(o(),l("button",{key:0,type:"button",onClick:i=>A(e),class:"px-3 py-1.5 rounded shadow bg-gray-100 dark:bg-neutral-800 hover:bg-gray-200 dark:hover:bg-neutral-700 transition text-sm"},"Assign Role",8,ds))]),"item-expand":$(e=>[s("button",{onClick:i=>N(e),class:"text-gray-500 hover:text-gray-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary rounded p-1 transition"},[f.value===e.id?(o(),l("svg",ps,t[11]||(t[11]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 15l7-7 7 7"},null,-1)]))):(o(),l("svg",ms,t[12]||(t[12]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])))],8,cs)]),expand:$(e=>[f.value===e.id?(o(),l("div",gs,[s("div",fs,[s("div",xs,[s("div",ys,[e.profile_photo_url?(o(),l("img",{key:0,src:e.profile_photo_url,class:"w-16 h-16 rounded-full border-2 border-gray-300 dark:border-neutral-600 object-cover shadow-sm",alt:`${e.name}'s profile photo`},null,8,bs)):(o(),l("div",hs,d(u(e.name)),1))]),s("div",null,[s("h3",vs,d(e.name),1),s("p",ks,d(e.email),1),e.username?(o(),l("p",_s,"@"+d(e.username),1)):_("",!0)])])]),s("div",ws,[s("div",Rs,[t[16]||(t[16]=s("div",{class:"font-semibold mb-1"},"Contact Information",-1)),s("div",$s,[s("div",null,[t[13]||(t[13]=s("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"Email:",-1)),s("span",As,d(e.email),1)]),e.phone_number?(o(),l("div",Cs,[t[14]||(t[14]=s("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"Phone:",-1)),s("span",js,d(e.phone_number),1)])):_("",!0),e.username?(o(),l("div",Ss,[t[15]||(t[15]=s("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-300"},"Username:",-1)),s("span",Vs,d(e.username),1)])):_("",!0)])]),s("div",Us,[t[17]||(t[17]=s("div",{class:"font-semibold mb-1"},"Roles & School Affiliations",-1)),e.roles_by_school&&Object.keys(e.roles_by_school).length?(o(),l("div",Ms,[(o(!0),l(j,null,V(e.roles_by_school,(i,r)=>(o(),l("div",{key:r,class:"mb-2"},[s("span",Es,d(r),1),i.length?(o(),l("span",Ps,[(o(!0),l(j,null,V(i,n=>(o(),l("span",{key:n.id,class:"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium shadow-sm bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 border border-purple-200 dark:border-purple-800 mr-1 mb-1"},d(n.name),1))),128))])):(o(),l("span",Ts,"No roles"))]))),128))])):(o(),l("div",Ns,"No school affiliations yet"))]),s("div",Os,[t[18]||(t[18]=s("div",{class:"font-semibold mb-1"},"Password",-1)),s("div",Bs,[s("span",Fs,[e.show_password&&e.decrypted_password?(o(),l(j,{key:0},[O(d(e.decrypted_password),1)],64)):(o(),l(j,{key:1},[O(" •••••••••••• ")],64))]),s("button",{onClick:i=>k("togglePasswordVisibility",e),class:"ml-2 p-1 rounded hover:bg-gray-200 dark:hover:bg-neutral-700 transition-colors",title:"View/Hide Password"},[e.show_password?(o(),B(H(be),{key:1,class:"w-4 h-4"})):(o(),B(H(ye),{key:0,class:"w-4 h-4"}))],8,Ds),s("button",{onClick:i=>k("resetPassword",e.id),class:"ml-2 px-2 py-1 rounded bg-blue-500 text-white text-xs hover:bg-blue-600 transition-colors",title:"Reset Password"}," Reset Password ",8,Hs)])])])])):_("",!0)]),_:1},8,["items","loading","expand-row-keys"]),P(oe,{modelValue:M.value,"onUpdate:modelValue":t[3]||(t[3]=e=>M.value=e),title:"Remove Role",message:"Are you sure you want to remove this role from the user? This action cannot be undone.",confirmText:"Remove",cancelText:"Cancel",onConfirm:W},null,8,["modelValue"])]))}},Ls={class:"max-w-6xl mx-auto w-full px-2 sm:px-4 md:px-0 py-8"},zs={class:"flex justify-between items-center mb-6"},at=re({__name:"Users",props:{users:{},roles:{},schools:{},filters:{},auth:{}},setup(c){const R=c,p=v(!1),k=v(!1),x=v(void 0),f=v({}),y=v(!1),U=v(void 0),F=v(""),m=v(void 0),u=v(R.roles||[]),S=q(()=>R.schools||[]),T=he(),{selectedSchool:b}=le(T),C=q(()=>Array.isArray(R.users)?R.users.filter(Boolean):R.users&&Array.isArray(R.users.data)?R.users.data.filter(Boolean):[]),A=Y({user_id:null,role_name:"",school_id:null}),N=v(""),M=v(!1);function I(r){r&&(m.value=r,p.value=!0)}const L=r=>{if(N.value="",!m.value||!r)return;A.user_id=m.value.id,A.role_name=r;const n=b.value&&typeof b.value.id=="number"?b.value.id:null;if(!n){N.value="No school selected.";return}A.school_id=n,M.value=!0,A.post("/settings/user-management/assign-role",{preserveScroll:!0,onSuccess:h=>{const w=h.props.flash;w?(w.warning&&g.warning(w.warning),w.success&&g.success(w.success),w.info&&g.info(w.info)):g.success("Role assigned successfully"),E(),m.value=void 0,A.role_name=""},onError:h=>{N.value=Object.values(h).flat().join(" "),Object.values(h).flat().forEach(w=>g.error(w))},onFinish:()=>{M.value=!1,A.reset(),A.user_id=null,A.role_name="",A.school_id=null}})};Y({user_id:null,role_id:null});const W=[{title:"Settings",href:"/settings/profile"},{title:"User Management",href:"/settings/users"}],G=ae();Z(()=>G.props.flash,r=>{r&&(r.success&&g.success(r.success),r.warning&&g.warning(r.warning),r.error&&g.error(r.error),r.info&&g.info(r.info),r.password_retrieved&&r.message&&g.info(r.message))}),ne(()=>{k.value=!1,x.value=void 0}),ie(()=>{k.value=!1,x.value=void 0,Object.values(f.value).forEach(r=>{clearTimeout(r)}),f.value={}});function E(){p.value=!1,m.value=void 0}const J=async r=>{r&&(r.show_password?z(r.id):(x.value=r,k.value=!0))},z=r=>{const n=C.value.find(h=>h.id===r);n&&(n.show_password=!1,f.value[r]&&(clearTimeout(f.value[r]),delete f.value[r]))},a=()=>{k.value=!1,x.value=void 0},t=async()=>{if(x.value){const r=C.value.find(n=>n.id===x.value.id);if(r)try{const h=await(await fetch(`/settings/user-management/get-password/${r.id}`)).json();h&&h.password?(r.decrypted_password=h.password,r.show_password=!0,f.value[r.id]=setTimeout(()=>{z(r.id)},3e5)):h&&h.error?g.error(h.error):g.error("Failed to retrieve password.")}catch{g.error("Failed to retrieve password.")}}a()};function e(r){U.value=r,y.value=!0}function i(r){F.value=r,y.value=!1,g.success("Password reset successfully. New password: "+r)}return(r,n)=>{const h=de("can");return o(),B(pe,{breadcrumbs:W},{default:$(()=>[P(H(ue),{title:"User Management"}),P(me,null,{default:$(()=>[s("div",Ls,[s("div",zs,[n[4]||(n[4]=s("h1",{class:"text-2xl font-bold"},"User Management",-1)),D((o(),B(H(ce),{href:"/settings/add-user",class:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2"},{default:$(()=>n[3]||(n[3]=[s("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})],-1),O(" Add New User ")])),_:1,__:[3]})),[[h,"create-users"]])]),n[5]||(n[5]=s("div",{class:"mb-6 p-4 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800"},[s("h3",{class:"text-sm font-semibold text-purple-800 dark:text-purple-200 mb-2"},"How User Role Assignment Works"),s("div",{class:"text-sm text-purple-700 dark:text-purple-300 space-y-1"},[s("p",null,"• Users are not linked to schools until they are assigned roles"),s("p",null,"• Select a school from the global school selector to assign roles for that school"),s("p",null,"• Each role assignment links the user to the selected school"),s("p",null,"• Users can have different roles in different schools"),s("p",null,"• Super admin role is system-wide and cannot be assigned manually")])],-1)),n[6]||(n[6]=s("p",{class:"mb-4 text-sm text-muted-foreground"},"Manage users and their roles. Search, filter, and assign roles to users.",-1)),P(Is,{users:C.value,roles:u.value,schools:S.value,auth:R.auth,onOpenAssignRoleModal:I,onTogglePasswordVisibility:J,onResetPassword:e},null,8,["users","roles","schools","auth"]),P(ze,{modelValue:p.value,"onUpdate:modelValue":n[0]||(n[0]=w=>p.value=w),user:m.value,school:H(b),roles:u.value,assigningRole:M.value,assignRoleError:N.value,onAssign:L,onCancel:E},null,8,["modelValue","user","school","roles","assigningRole","assignRoleError"]),P(ge,{modelValue:k.value,"onUpdate:modelValue":n[1]||(n[1]=w=>k.value=w),onSuccess:t,onCancel:a},null,8,["modelValue"]),y.value?(o(),B(fe,{key:0,"user-id":U.value,onSuccess:i,onCancel:n[2]||(n[2]=()=>y.value=!1)},null,8,["user-id"])):_("",!0)])]),_:1})]),_:1})}}});export{at as default};
